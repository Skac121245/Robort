<!DOCTYPE html>
<html>
<head>
  <title>FRC Match Strategy Planner</title>
  <style>
    body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .controls {
    margin-bottom: 20px;
    background-color: #ffffff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  select, button, input {
    padding: 10px;
    margin-right: 5px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    transition: border-color 0.3s;
  }

  button {
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    border: none;
  }

  button:hover {
    background-color: #45a049;
  }

  #strategyCanvas {
      background-image: url('https://www.chiefdelphi.com/uploads/default/original/3X/a/a/aa745548020a507cf4a07051dcd0faa446607840.png');
      background-size: contain;
      border: 1px solid #000;
      width: 1152; /* Adjust based on your actual need */
      height: 498; /* Adjust based on your actual need */
    }

  select:focus, button:focus, input:focus {
    border-color: #4CAF50;
    outline: none;
  }

  #eventCodeInput {
    flex-grow: 1;
  }
  </style>
</head>
<body>

<div class="controls">
  <input type="text" id="eventCodeInput" placeholder="Enter Event Code" value="2024mabri"/>
  <button onclick="fetchMatches()">Load Matches</button>
</div>
<select id="matchSelect"></select>
<button onclick="clearCanvas()">Clear</button>
<canvas id="strategyCanvas" width="1536" height="664"></canvas>

<script>
    const canvas = document.getElementById('strategyCanvas');
    const ctx = canvas.getContext('2d');
    const matchSelect = document.getElementById('matchSelect');
    let matches = [];
    let drawing = false;
    let drawColor = 'black';
    let teamPositions = [];
  
    const bluePositions = [{x: 70, y: 150}, {x: 70, y: 380}, {x: 70, y: 500}];
    const redPositions = [{x: 1400, y: 500}, {x: 1400, y: 380}, {x: 1400, y: 150}];
    const teamColors = {
      blue: ['#07f7df', '#075bf7', '#7307f7'],
      red: ['#f70707', '#f76707', '#f7c707']
    };
  
    setupCanvas();
  
    function setupCanvas() {
      canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        checkTeamClick(e.offsetX, e.offsetY);
      });
      canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
      canvas.addEventListener('mousemove', function(e) {
        if (drawing) {
          draw(e.offsetX, e.offsetY);
        }
      });
    }
  
    function draw(x, y) {
      ctx.lineWidth = 4;
      ctx.lineCap = 'round';
      ctx.strokeStyle = drawColor;
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }
  
    function checkTeamClick(x, y) {
    for (const team of teamPositions) {
      // Adjust click detection area if necessary
      if (x >= team.x && x <= (team.x + team.width) && y >= (team.y - team.height) && y <= team.y) {
        drawColor = team.color;
        break; // Stop the loop once the correct team is found
      }
    }
  }
  
    function fetchMatches() {
      const eventCode = document.getElementById('eventCodeInput').value;
      const webhookEndpoint = `https://www.thebluealliance.com/api/v3/event/${eventCode}/matches/simple`;
      fetch(webhookEndpoint, {
        method: "GET",
        headers: {
          "X-TBA-Auth-Key": "J43Af3iggAp3XBvsVaGm5Hbc7IlK6XR8W8WxQhLDlPiQbv6BbW8LWDvVg8Zj9fCV",
        },
      })
      .then(response => response.json())
      .then(data => {
        matches = data;
        populateMatchSelect(data);
      })
      .catch(error => console.error('Error fetching matches:', error));
    }
  
    function populateMatchSelect(matches) {
      matchSelect.innerHTML = '';
      
      // Sort matches by their match number
      matches.sort((a, b) => {
        let compLevelA = a.comp_level + a.set_number.toString().padStart(3, '0') + a.match_number.toString().padStart(3, '0');
        let compLevelB = b.comp_level + b.set_number.toString().padStart(3, '0') + b.match_number.toString().padStart(3, '0');
        return compLevelA.localeCompare(compLevelB);
      });

      matches.forEach(match => {
        const option = document.createElement('option');
        option.value = match.key;
        option.textContent = `${match.comp_level.toUpperCase()} Match ${match.match_number}`;
        matchSelect.appendChild(option);
      });
    }
  
    function displayTeamsForSelectedMatch() {
      const selectedMatchKey = matchSelect.value;
      const match = matches.find(m => m.key === selectedMatchKey);
      if (!match) return;
      clearCanvas();
      teamPositions = []; // Reset team positions
  
      drawTeams(match.alliances.blue.team_keys, bluePositions, 'blue');
      drawTeams(match.alliances.red.team_keys, redPositions, 'red');
    }
  
    function drawTeams(teamKeys, positions, alliance) {
      teamKeys.forEach((key, index) => {
        const teamNumber = key.replace('frc', '');
        const position = positions[index];
        const color = teamColors[alliance][index];
        drawText(teamNumber, position.x, position.y, color, index, alliance);
      });
    }
  
    function drawText(text, x, y, color, index, alliance) {
    // Calculate text width for background and click detection area
    ctx.font = '40px Arial'; // Ensure font size is set before measuring text
    const textMetrics = ctx.measureText(text);
    const textWidth = textMetrics.width;
    const padding = 10; // Padding around the text for the outline box

    // Adjust position for the rectangle to be centered on the text if necessary
    const rectX = x - padding / 2;
    const rectY = y - 40; // Adjust based on font size and desired box size
    const rectWidth = textWidth + padding;
    const rectHeight = 50;

    // Draw the colored background rectangle
    ctx.fillStyle = color;
    ctx.fillRect(rectX, rectY, rectWidth, rectHeight);

    // Draw the team number text on top
    ctx.fillStyle = 'black'; // Contrast color for text
    ctx.fillText(text, x, y);

    // Update the teamPositions array for click detection
    teamPositions.push({
      x: rectX,
      y: rectY,
      width: rectWidth,
      height: rectHeight,
      color: color // Assign the drawing color for when the area is clicked
    });
  }
  
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  
    matchSelect.addEventListener('change', displayTeamsForSelectedMatch);
    fetchMatches(); // Automatically fetch matches on load
  </script>  
</body>
</html>
