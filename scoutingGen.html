<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRC Scouting Page</title>

<link rel="stylesheet" href="jquery-ui.css">
<link href="bootstrap.min.css" rel="stylesheet">
<script src="showdown.min.js"></script>

<!-- Load jQuery first -->
<script src="jquery-3.5.1.min.js"></script>
<script>window.jQuery || document.write('<script src="jquery-3.5.1.min.js"><\/script>')</script>

<!-- Then jQuery UI -->
<script src="jquery-ui.js"></script>

<!-- And then Bootstrap -->
<script src="bootstrap.min.js"></script>
<script>window.jQuery.fn.modal || document.write('<script src="bootstrap.min.js"><\/script>')</script>

<script src="xlsx.full.min.js"></script>
<style>
         #aboutTabsContent > .tab-pane {
    padding-top: 20px; /* Add space above the content in each tab */
}
    body {
        background-color: #343a40;
        display: block;
    }
    body, nav, header, .navbar, #footer {
      transition: background-color 0.3s ease, color 0.3s ease;
  }
    .ui-autocomplete {
        z-index: 1051 !important; /* Bootstrap modals usually have a z-index of 1050 */
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .modal-body .form-group {
        margin-bottom: 10px; /* Adjust spacing between form groups in the modal */
    }
    #exclusionList li {
        margin-bottom: 5px; /* Spacing between list items */
    }
    .btn-spacing {
        margin-left: 10px;
    }
    .highlighted {
        background-color: #ffff99 !important;
    }
    /* Dark Mode Toggle Switch Styles */
.switch {
  position: relative;
  display: inline-block;
  width: 80px;
  height: 34px;
  margin: 10px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: background-color .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: transform .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #555; /* Dark mode slider color */
}

input:checked + .slider:before {
  transform: translateX(46px); /* Slide to the right */
}

.icon {
  color: #fff;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  transition: opacity 0.4s; /* Smooth transition for opacity */
}

.sun {
  left: 10px;
  opacity: 0; /* Start hidden */
}

.moon {
  right: 10px;
  opacity: 1; /* Start visible */
}

input:checked + .slider .sun {
  opacity: 1; /* Fade in when dark mode is on */
}

input:checked + .slider .moon {
  opacity: 0; /* Fade out when dark mode is on */
}

input:not(:checked) + .slider .sun {
  opacity: 0; /* Remain hidden when light mode is on */
}

input:not(:checked) + .slider .moon {
  opacity: 1; /* Remain visible when light mode is on */
}

body .bg-dark #patch-notes, #aboutTabsContent {
    color: #f8f9fa !important; /* Sets the text color for all content within the patch-notes container */
}

body .bg-dark #patch-notes h3, #patch-notes p, #patch-notes a {
    color: inherit !important; /* Ensures that headers, paragraphs, and links inherit the same color */
}

body .bg-light #patch-notes, #aboutTabsContent {
    color: #343a40 !important; /* Sets the text color for all content within the patch-notes container */
}

body .bg-light #patch-notes h3, #patch-notes p, #patch-notes a {
    color: inherit !important; /* Ensures that headers, paragraphs, and links inherit the same color */
}

/* Styles for dark and light modes */
.bg-dark, .navbar-dark {
  background-color: #343a40 !important; /* Dark gray background */
  color: #f8f9fa !important; /* Light text for readability */
}

.bg-light, .navbar-light, .card {
  background-color: #f8f9fa !important; /* Light gray background */
  color: #343a40 !important; /* Dark text for readability */
}

/* Enhanced specific selectors for navbar in dark mode */
.navbar-dark {
  background-color: #343a40 !important; /* Dark gray background */
  color: #f8f9fa !important; /* Light text for readability */
}

.navbar-dark .navbar-nav .nav-link,
.navbar-dark .navbar-brand {
  color: #f8f9fa !important; /* Ensure navbar text colors are adjusted for dark mode */
}

.navbar-dark .navbar-toggler-icon {
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath stroke='rgba(248, 249, 250, 1)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
}

.nav-link.active {
  color: #343a40 !important;
}


body.bg-dark td, th {
    color: #f8f9fa
}
body.bg-dark p, h5 {
    color: #343a40
}

body.bg-dark .dropdown-item {
    background-color: #343a40 !important; /* Dark gray background */
  color: #f8f9fa !important; /* Light text for readability */
}
body.bg-dark .dropdown-item:hover {
    background-color: #f8f9fa !important; /* Light gray background */
  color: #343a40 !important; /* Dark text for readability */
}
body.bg-dark .dropdown-menu {
    background-color:  #343a40 !important; /* Light gray background */
}
</style>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.body.style.display = "none"; // Hide body as soon as DOM is ready but not fully loaded
    });
</script>
</head>
<body>
    <nav class="navbar navbar-expand-lg shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="#" id="roborte">Robort</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./Team_List_element.html">Teams</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Scouting
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="./Strat_Board_w_tabs.html">Canvas</a>
                            <a class="dropdown-item" href="./scoutingGen.html">Scouting Generator</a>
                            <a class="dropdown-item" href="./scoutingUI.html">Live Scouter (WIP)</a>
                        <a class="dropdown-item" href="./pitScouterFRONT.html">Pit Scouter</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./Checklist.html">Pre Match Checklist</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./2423_Features.html">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Config_tab.html">Configure</a>
                    </li>
                </ul>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider round">
                      <span class="icon sun">🌞</span> <!-- Sun icon -->
                      <span class="icon moon">🌜</span> <!-- Moon icon -->
                    </span>
                  </label>
            </div>
        </div>
    </nav>
<div class="container">
    <h1>FRC Scouting List Generator</h1>
    <form id="scoutingForm">
        <div class="form-group">
            <label for="eventCode">Event Code:</label>
            <div class="input-group">
                <input type="text" class="form-control" id="eventCode" required>
                <div class="input-group-append">
                    <button class="btn btn-success" type="button" id="uploadButton">Upload</button>
                    <button class="btn btn-secondary" type="button" id="configButton">Config</button>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="teamsPerMatch">Teams per Match:</label>
            <input type="number" class="form-control" id="teamsPerMatch" min="1" max="6" required>
        </div>
        <div class="form-group">
            <label for="teamAppearances" title="Controls the maximum number of times a given team can appear for the entire competition.">Team Appearances: <span id="appearanceValue">1</span></label>
            <input type="range" class="custom-range" id="teamAppearances" min="1" max="12" value="1">
        </div>

        
        
        <button type="submit" class="btn btn-primary" id="fetchMatchesButton">Fetch Matches</button>
    <!-- Button to trigger modal -->
    <button type="button" class="btn btn-primary" id="excludeTeamsButton" data-toggle="modal" data-target="#excludeTeamsModal">
        Exclude Teams
    </button>
    <!-- Export to Excel button -->
<button type="button" id="exportExcel" class="btn btn-success" style="display:none;">Export to Excel</button>
<!-- Print button -->
<button type="button" id="printButton" class="btn btn-secondary" style="display:none;" onclick="printTable()">Print</button>
<button type="button" id="simulateButtonn" class="btn btn-info" style="display:none;">
    Simulate
</button>
<div class="form-group">
    <div id="highlightGroup" style="display:none;">
    <label for="highlightTeamSelect"><br>Highlight Team:</label>
    <select class="form-control" id="highlightTeamSelect">
        <option value="">Select a team to highlight</option>
    </select>
</div>
</div>
    </form>
    <table class="table table-bordered mt-4 data-table">
        <thead style="display:none;">
            <tr>
                <th style="background-color: #f8f9fa !important; color:#343a40 !important;">Match</th>
                <th style="background-color: #f8f9fa !important; color:#343a40 !important;">Teams</th>
            </tr>
        </thead>
        <tbody id="matchData"></tbody>
    </table>
</div>
<div id="messageContainer" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <div class="alert alert-success" id="successMessage"></div>
</div>
 <!-- Alert Modal -->
 <div class="modal fade" id="customAlertModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">Alert</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="modalText">This is a modal replacing an alert.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Criteria Error Modal -->
<div class="modal fade" id="criteriaErrorModal" tabindex="-1" role="dialog" aria-labelledby="criteriaErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="criteriaErrorModalLabel">Impossible Criteria</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Your scouting criteria cannot be met with this event's data. Please adjust your settings and try again.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
<!-- About the Project Modal -->
<div id="aboutModal" class="modal text-center modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="aboutTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="about-tab" data-toggle="tab" href="#about" role="tab" aria-controls="about" aria-selected="true">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="patch-notes-tab" data-toggle="tab" href="#patch-notes" role="tab" aria-controls="patch-notes" aria-selected="false">Patch Notes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="feedback-tab" data-toggle="tab" href="#feedback" role="tab" aria-controls="feedback" aria-selected="false">Feedback</a>
                    </li>
                </ul>
                <div class="tab-content" id="aboutTabsContent">
                    <div class="tab-pane fade show active" id="about" role="tabpanel" aria-labelledby="about-tab">
                        <h2>Robort</h2>
                        <h4>The ultimate in FRC competition gear</h4>
                        <h5>Co-developed by Ben Skraly and Toba Banjo</h5>
                        <p>Whether you're preparing to scout a heated match, sharing information about your team, or analyzing other robots, Robort has got you covered. Complete with modular design and accessible systems, it's the best tool both on and off the field.</p>
                        <span>&copy; <script>document.write(new Date().getFullYear());</script> Watertown High School Robotics</span>
                    </div>
                    <div class="tab-pane fade" id="patch-notes" role="tabpanel" aria-labelledby="patch-notes-tab">
                        <!-- Patch notes will be populated here by JavaScript -->
                    </div>
                    <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
                        <form id="feedbackForm">
                            <div class="form-group">
                                <label for="feedbackType">Select Feedback Type:</label>
                                <select class="form-control" id="feedbackType" onchange="toggleFeedbackForm()">
                                    <option value="feature">Feature Suggestion</option>
                                    <option value="bug">Bug Report</option>
                                </select>
                            </div>
                            <!-- Feature Suggestion Form -->
                            <div id="featureForm" style="display: block;">
                                <div class="form-group">
                                    <label>Feature Area: <label style="color:red">*</label></label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="featureArea" id="statistics" value="Statistics/Data">
                                            <label class="form-check-label" for="statistics">Statistics/Data</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="featureArea" id="scouting" value="Scouting">
                                            <label class="form-check-label" for="scouting">Scouting</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="featureArea" id="quality" value="Quality of Life">
                                            <label class="form-check-label" for="quality">Quality of Life</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="featureArea" id="other" value="Other">
                                            <label class="form-check-label" for="other">Other</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="featureDescription">Description:</label>
                                    <textarea class="form-control" id="featureDescription" rows="3"></textarea>
                                </div>
                            </div>
                            <!-- Bug Report Form -->
                            <div id="bugForm" style="display: none;">
                                <div class="form-group">
                                    <label for="bugTitle">Title:</label>
                                    <input type="text" class="form-control" id="bugTitle">
                                </div>
                                <div class="form-group">
                                    <label for="bugSummary">Issue Summary:</label>
                                    <textarea class="form-control" id="bugSummary" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="bugSteps">Steps to Reproduce:</label>
                                    <textarea class="form-control" id="bugSteps" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="bugResults">Expected vs. Actual Results:</label>
                                    <textarea class="form-control" id="bugResults" rows="2"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>                    
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function collectTeams(matches) {
    var teams = [];
    matches.forEach(function(match) {
        match.alliances.red.team_keys.concat(match.alliances.blue.team_keys).forEach(function(team) {
            team = team.replace('frc', ''); // Normalize team number
            if (teams.indexOf(team) === -1) {
                teams.push(team);
            }
        });
    });
    updateHighlightTeamDropdown(teams.sort());
}

    function updateHighlightTeamDropdown(teams) {
    var select = $('#highlightTeamSelect');
    select.empty(); // Clear previous options
    select.append('<option value="">Select a team to highlight</option>');
    teams.forEach(function(team) {
        select.append($('<option></option>').val(team).text(team));
    });
}
$('#highlightTeamSelect').change(function() {
    var selectedTeam = $(this).val();
    $('.team-number').each(function() {
        $(this).css('background-color', ''); // Reset highlight for all team number spans
        if (selectedTeam && $(this).text() === selectedTeam) {
            $(this).css('background-color', '#ffff99'); // Apply highlight color
            $(this).css('color', '#343a40');
            $(this).css('font-weight', '30px');
        }
    });
});

        document.addEventListener('DOMContentLoaded', function() {
  const originalAlert = window.alert;
  
  window.alert = function(message) {
    $('#modalText').text(message); // Set the text of the modal to the alert message
    $('#customAlertModal').modal('show'); // Show the Bootstrap modal
  };
});

    function displaySuccessMessage(message) {
    var messageBox = $('#successMessage');
    messageBox.text(message);
    $('#messageContainer').fadeIn();

    setTimeout(function() {
        $('#messageContainer').fadeOut();
    }, 4000); // Message will fade out after 4 seconds
}

    $(document).ready(function() {
        $('#excludeTeamsButton').hide(); 
        // Handling the form submission
        $('#scoutingForm').on('submit', function(e) {
            e.preventDefault();
            fetchMatches($('#eventCode').val(), parseInt($('#teamsPerMatch').val(), 10));
        });
    
        // Configuration button navigation
        $('#configButton').click(function() {
            window.location.href = 'Config_tab.html';
        });
    
        // Slider adjustment and display update
        $('#teamAppearances').on('input', function() {
            $('#appearanceValue').text($(this).val());
        });
    
        // Disable the event code input if a code is stored
        var storedEventCode = localStorage.getItem('eventCode');
        if (storedEventCode) {
            $('#eventCode').val(storedEventCode);
            $('#eventCode').prop('disabled', true);
        }
    });
    
    // Fetch matches from The Blue Alliance API
    function fetchMatches(eventCode, teamsPerMatch) {
        if ($('#fetchMatchesButton').text() === 'Fetch Matches from Upload') {
        var matches = JSON.parse(localStorage.getItem('uploadedMatches'));
        let feasible = checkFeasibility(
            matches.filter(m => m.comp_level === 'qm'),
            teamsPerMatch,
            parseInt($('#teamAppearances').val(), 10)
        );
        if (!feasible) {
            // Show error and do NOT proceed
            $('#criteriaErrorModal').modal('show');
            return; // Skip displayMatches entirely
        }
        displayMatches(matches, teamsPerMatch);
        originalMatches = matches;
        $('#excludeTeamsButton').show();
    } else {
        var url = `https://www.thebluealliance.com/api/v3/event/${eventCode}/matches/simple`;
        $.ajax({
            url: url,
            headers: {
                'X-TBA-Auth-Key': 'J43Af3iggAp3XBvsVaGm5Hbc7IlK6XR8W8WxQhLDlPiQbv6BbW8LWDvVg8Zj9fCV' // Replace with your actual API Key
            },
            success: function(data) {
                data = data.filter(match => match.comp_level === 'qm');
                data.sort((a, b) => a.match_number - b.match_number);
                let feasible = checkFeasibility(
                    data, 
                    teamsPerMatch, 
                    parseInt($('#teamAppearances').val(), 10)
                );
                if (!feasible) {
                    $('#criteriaErrorModal').modal('show');
                    return; // Don’t call displayMatches
                }
                originalMatches = data;
                displayMatches(data, teamsPerMatch);
                $('#excludeTeamsButton').show(); 
            },
            error: function() {
                alert('Failed to retrieve data. Check the event code and your internet connection.');
            }
        });
    }
    }
    function checkFeasibility(matches, teamsPerMatch, teamAppearances) {
    // Count how many QM (Qualification) matches
    // We assume 'matches' is already filtered so it only has comp_level='qm'.
    let numMatches = matches.length;
    
    // Collect all distinct teams from these matches
    let allTeams = new Set();
    matches.forEach(match => {
        match.alliances.red.team_keys.concat(match.alliances.blue.team_keys).forEach(team => {
            allTeams.add(team.replace('frc', ''));
        });
    });
    
    let distinctTeams = allTeams.size;
    
    // If total capacity < total required
    if ((numMatches * teamsPerMatch) < (distinctTeams * teamAppearances)) {
        return false;  // means "Impossible"
    }
    return true;       // means "Feasible"
}

    // Display the matches in the table with filtering based on team appearances
    function displayMatches(matches, teamsPerMatch) {
    $('#matchData').parents('table').find('thead').show();
    $('#exportExcel').show();
    $('#printButton').show();
    $('#excludeTeamButton').show();
    $('#highlightGroup').show();
    var matchData = '';
    let simulationData = [];
    let appearanceCount = {};
    let teamFlags = {}; // Tracks whether each team has ever been chosen


    matches.forEach(function(match, index) {
        var teams = match.alliances.red.team_keys.concat(match.alliances.blue.team_keys);
        teams = teams.map(team => team.replace('frc', '')); // Normalize team numbers
        // Build a small map of alliance color for each team in this match
let allianceMap = {};
match.alliances.red.team_keys.forEach(t => {
    t = t.replace('frc', '');
    allianceMap[t] = 'red';
});
match.alliances.blue.team_keys.forEach(t => {
    t = t.replace('frc', '');
    allianceMap[t] = 'blue';
});

        // Initially filter teams based on the current appearances not exceeding the max allowed
        let potentialTeams = teams.filter(team => (appearanceCount[team] || 0) < $('#teamAppearances').val());
        // Separate unflagged vs flagged in THIS match
let matchUnflagged = potentialTeams.filter(t => !teamFlags[t]);
let pickFrom       = (matchUnflagged.length > 0) ? matchUnflagged : potentialTeams;

        // Now limit the teams based on the 'Teams per Match' setting
        let displayedTeams = [];
        for (let i = 0; i < pickFrom.length && displayedTeams.length < teamsPerMatch; i++) {
    let team = pickFrom[i];
    // Double-check you haven't exceeded the slider's max appearances
    if ((appearanceCount[team] || 0) + 1 <= parseInt($('#teamAppearances').val(), 10)) {
        // Mark a new appearance
        appearanceCount[team] = (appearanceCount[team] || 0) + 1;
        // Once a team is picked, set its flag on
        if (!teamFlags[team]) {
            teamFlags[team] = true;
        }
        displayedTeams.push(team);
    }
}

// Build a snapshot of all teams' states
let teamsState = {};
teams.forEach(t => {
    const flagged = !!teamFlags[t];
    const done = (appearanceCount[t] || 0) >= parseInt($('#teamAppearances').val(), 10);
    const alliance = allianceMap[t] || 'neutral'; // fallback if not found

    teamsState[t] = { flagged, done, alliance };
});



// Save info for the simulation feature
simulationData.push({
    matchNumber: match.match_number,
    teamsPicked: [...displayedTeams],
    teamsState: teamsState
});
        // Add the match row only if there are displayed teams
        if (displayedTeams.length > 0) {
            matchData += `<tr><td>Match ${match.match_number}</td><td>${displayedTeams.map(team => `<span class='team-number'>${team}</span>`).join(', ')}</td></tr>`;
        }
    });

    $('#matchData').html(matchData);
    setupSimulation(simulationData);
    setupTeamAutocomplete(); 
    collectTeams(matches); 
}

let exclusionList = [];

$(document).ready(function() {
    var availableTeams = [];  // This will store the teams loaded for Autocomplete

    function setupTeamAutocomplete() {
        $("#matchData tr td:nth-child(2)").each(function() {
            var teams = $(this).text().split(', ');
            teams.forEach(function(team) {
                if (availableTeams.indexOf(team) === -1) {
                    availableTeams.push(team);
                }
            });
        });

        $('#excludeTeamInput').autocomplete({
            source: availableTeams,
            select: function(event, ui) {
                $(this).data('autocomplete-selected', true);  // Flag that a valid selection was made
            }
        });
    }

    $('#addExclusion').click(function() {
        var teamNum = $('#excludeTeamInput').val().trim();
        var isSelectedFromDropdown = $('#excludeTeamInput').data('autocomplete-selected');  // Check the flag

        // Only add the team if it was selected from the dropdown
        if (teamNum && isSelectedFromDropdown) {
            if (!exclusionList.includes(teamNum)) {
                exclusionList.push(teamNum);
                updateExclusionListDisplay();
                filterMatches();
            }
            $('#excludeTeamInput').val('');  // Clear input
            $('#excludeTeamInput').removeData('autocomplete-selected');  // Reset the flag
        } else {
            alert('Please select a team from the dropdown list.');
            $('#excludeTeamInput').focus();
        }
    });
});

function updateExclusionListDisplay() {
    var listHtml = '';
    exclusionList.forEach(function(team) {
        listHtml += `<li>${team} <button onclick="removeFromExclusion('${team}')" class="btn btn-sm btn-danger">Remove</button></li>`;
    });
    $('#exclusionList').html(listHtml);
}

function removeFromExclusion(team) {
    var index = exclusionList.indexOf(team);
    if (index > -1) {
        exclusionList.splice(index, 1);
        updateExclusionListDisplay();
        filterMatches(); // Refilter matches whenever the list changes
    }
}

function filterMatches() {
    // Filter the original matches based on the exclusion list
    var filteredMatches = originalMatches.filter(match => {
        var teams = match.alliances.red.team_keys.concat(match.alliances.blue.team_keys);
        teams = teams.map(team => team.replace('frc', ''));
        return !teams.some(team => exclusionList.includes(team));
    });
    
    // Display the matches after filtering
    displayMatches(filteredMatches, parseInt($('#teamsPerMatch').val(), 10));
}

function setupTeamAutocomplete() {
    var availableTeams = [];
    $("#matchData tr td:nth-child(2)").each(function() {
        var teams = $(this).text().split(', ');
        teams.forEach(function(team) {
            if (availableTeams.indexOf(team) === -1) {
                availableTeams.push(team);
            }
        });
    });

    $('#excludeTeamInput').autocomplete({
        source: availableTeams,
        select: function(event, ui) {
            if (!exclusionList.includes(ui.item.value)) {
                exclusionList.push(ui.item.value);
                updateExclusionListDisplay();
                filterMatches();
            }
            $(this).val(''); // Clear input after selection
            return false; // Prevent the widget from inserting the value.
        }
    });
}

function exportTableToExcel(tableID){
    var eventCode = $('#eventCode').val(); // Get the event code from the input
    var filename = `ScoutingList_${eventCode}`; // Create filename with event code
    let table = document.getElementById(tableID);
    let workbook = XLSX.utils.table_to_book(table, {raw: true, sheet: "Sheet 1"});
    XLSX.writeFile(workbook, `${filename}.xlsx`);
}

$('#exportExcel').click(function(){
    exportTableToExcel('matchData');
});

function printTable() {
    var table = document.querySelector('.data-table').outerHTML;
    var printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Print Table</title>');
    printWindow.document.write('<link rel="stylesheet" href="bootstrap.min.css" />');
    printWindow.document.write('<style>');
    printWindow.document.write('@media print { body { width: 100%; margin: 0; font-size: 4pt; } .data-table { width: 100%; font-size: 6pt; } .data-table th, .data-table td { padding: 2px; } .navbar, #buttonContainer { display: none; } }');
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(table);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}
$('#uploadButton').click(function() {
    $('<input type="file" accept=".json">').on('change', function(event) {
        var fileReader = new FileReader();
        fileReader.onload = function(e) {
            try {
                var jsonData = JSON.parse(e.target.result);
                if (Array.isArray(jsonData) && jsonData.every(match => match.hasOwnProperty('event_key'))) {
                    localStorage.setItem('uploadedMatches', JSON.stringify(jsonData));
                    $('#eventCode').val(jsonData[0].event_key);
                    $('#fetchMatchesButton').text('Fetch Matches from Upload');
                    $('<button class="btn btn-danger btn-spacing" type="button" id="cancelUploadButton">Cancel</button>')
                        .insertAfter('#fetchMatchesButton')
                        .click(function() {
                            $(this).remove();
                            $('#fetchMatchesButton').text('Fetch Matches');
                            $('#uploadButton').prop('disabled', false);
                            localStorage.removeItem('uploadedMatches'); // Ensures clean state
                        });
                    $('#uploadButton').prop('disabled', true);
                    $('#eventCode').prop('disabled', true);
                    displaySuccessMessage('File loaded successfully.');
                } else {
                    alert('Invalid JSON format');
                }
            } catch (error) {
                alert('Error reading JSON file');
            }
        };
        fileReader.readAsText(event.target.files[0]);
    }).click();
});


    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          const toggle = document.getElementById('darkModeToggle');
          const body = document.body;
          const navbar = document.querySelector('.navbar'); // Select the navbar element
        
          // Function to apply dark mode classes
          function enableDarkMode() {
            body.classList.add('bg-dark');
            body.classList.remove('bg-light');
            navbar.classList.add('navbar-dark');
            navbar.classList.remove('navbar-light', 'bg-white');
            document.querySelectorAll('.navbar').forEach(element => {
              element.classList.add('bg-dark');
              element.classList.remove('bg-white');
            });
            document.querySelectorAll('.form-control').forEach(element => {
      element.classList.add('bg-dark');
      element.classList.remove('bg-white');
    });
          }
        
          // Function to remove dark mode classes
          function disableDarkMode() {
            body.classList.add('bg-light');
            body.classList.remove('bg-dark');
            navbar.classList.add('navbar-light');
            navbar.classList.remove('navbar-dark', 'bg-dark');
            document.querySelectorAll('.navbar').forEach(element => {
              element.classList.add('bg-white');
              element.classList.remove('bg-dark');
            });
            document.querySelectorAll('.form-control').forEach(element => {
      element.classList.remove('bg-dark');
      element.classList.add('bg-white');
    });
          }
        
          // Initialize dark mode from local storage
          if (localStorage.getItem('darkMode') === 'true') {
            enableDarkMode();
            toggle.checked = true;
          } else {
            disableDarkMode();
          }
          body.style.display = 'block';

          // Toggle dark mode on change
          toggle.addEventListener('change', function() {
            if (this.checked) {
              localStorage.setItem('darkMode', 'true');
              enableDarkMode();
            } else {
              localStorage.setItem('darkMode', 'false');
              disableDarkMode();
            }
          });
        });

           document.getElementById('roborte').addEventListener('click', function() {
    $('#aboutModal').modal('show');
});

// Fetch and display GitHub release notes with markdown parsing and specific download link
function loadGitHubReleases() {
    const apiUrl = 'https://api.github.com/repos/skac121245/Robort/releases';
    const converter = new showdown.Converter(); // Initialize markdown converter
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('patch-notes');
            container.innerHTML = ''; // Clear existing content
            data.forEach(release => {
                if (release.body !== null) { // Only display if there's a description
                    const markdownHTML = converter.makeHtml(release.body);
                    const releaseDiv = document.createElement('div');
                    releaseDiv.innerHTML = `
                        <h3>${release.tag_name}</h3>
                        <div>${markdownHTML}</div>
                        <a href="${release.html_url}" target="_blank">View on GitHub</a>
                        <hr>`;
                    container.appendChild(releaseDiv);
                }
            });
        })
        .catch(error => console.error('Error fetching GitHub releases:', error));
}



document.getElementById('patch-notes-tab').addEventListener('click', function() {
    loadGitHubReleases();
});
document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
    event.preventDefault();  // Prevent the default form submission behavior
    const feedbackType = document.getElementById('feedbackType').value;
    let postData = {
        username: "Robort Feedback Bot",
        embeds: [],
    };

    if (feedbackType === 'feature') {
        const area = document.querySelector('input[name="featureArea"]:checked').value;
        const description = document.getElementById('featureDescription').value;
        postData.embeds.push({
            title: "Feature Suggestion",
            fields: [
                { name: "Area", value: area, inline: true },
                { name: "Description", value: description }
            ],
            color: 65280  // Green
        });
    } else {
        const title = document.getElementById('bugTitle').value;
        const summary = document.getElementById('bugSummary').value;
        const steps = document.getElementById('bugSteps').value;
        const results = document.getElementById('bugResults').value;
        postData.embeds.push({
            title: "Bug Report: " + title,
            fields: [
                { name: "Summary", value: summary },
                { name: "Steps to Reproduce", value: steps },
                { name: "Expected vs. Actual Results", value: results }
            ],
            color: 16711680  // Red
        });
    }

    try {
        const response = await fetch('https://discord.com/api/webhooks/1231365349476405268/lX0MXxHO2zwQPnNxEiuConQ8Sf47Qwq4EDrE8mLV8pctu3c63VQBjnsjAwlGLK2DPeLm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(postData)
        });
        if (response.ok) {
            alert('Feedback submitted successfully!');
            document.getElementById('feedbackForm').reset();  // Reset the form after successful submission
        } else {
            alert('Failed to submit feedback. Please try again.');
        }
    } catch (error) {
        console.error('Error submitting feedback:', error);
        alert('Error submitting feedback. Please check your network connection and try again.');
    }
});

function toggleFeedbackForm() {
    const feedbackType = document.getElementById('feedbackType').value;
    if (feedbackType === 'feature') {
        document.getElementById('featureForm').style.display = 'block';
        document.getElementById('bugForm').style.display = 'none';
    } else {
        document.getElementById('featureForm').style.display = 'none';
        document.getElementById('bugForm').style.display = 'block';
    }
}
function setupSimulation(simData) {
    // If no matches, hide simulate button
    if (!simData || simData.length === 0) {
        $('#simulateButton').hide();
        return;
    }

    // Show the simulate button
    $('#simulateButton').show();

    // Configure the slider boundaries
    $('#simSlider').attr('max', simData.length);
    $('#simSlider').val(1);

    // When you move the slider, show the corresponding match info
    $('#simSlider').off('input').on('input', function() {
    let idx = parseInt($(this).val(), 10) - 1;
    displaySimMatch(simData[idx], simData);  // pass 'simData' as second param
});

    // Also define the "Simulate" button click
    $('#simulateButton').off('click').on('click', function() {
        // Open the modal
        $('#simulationModal').modal('show');
        // Show the first match by default
        $('#simSlider').val(1).trigger('input');
    });

    // Setup the play button
    let playing = false;
    let intervalId;

    $('#playSimulation').off('click').on('click', function() {
        if (!playing) {
            playing = true;
            $('#playSimulation').text('Pause');
            intervalId = setInterval(function() {
                let currentVal = parseInt($('#simSlider').val(), 10);
                if (currentVal < simData.length) {
                    $('#simSlider').val(currentVal + 1).trigger('input');
                } else {
                    clearInterval(intervalId);
                    playing = false;
                    $('#playSimulation').text('Play');
                }
            }, 1000); // 1 second per match step
        } else {
            // Pause
            playing = false;
            clearInterval(intervalId);
            $('#playSimulation').text('Play');
        }
    });
    // 1) Show/hide all matches list
$('#showAllMatchesCheckbox').off('change').on('change', function() {
    let isChecked = $(this).is(':checked');
    $('#allMatchesList').toggle(isChecked);
    if (isChecked) {
        // Force an update in case user has already moved the slider
        let idx = parseInt($('#simSlider').val(), 10) - 1;
        displayAllMatchesSoFar(simData, idx);
    }
});

// 2) Show/hide team flags
$('#showTeamFlagsCheckbox').off('change').on('change', function() {
    let isChecked = $(this).is(':checked');
    $('#teamsFlagsContainer').toggle(isChecked);
    if (isChecked) {
        // Force an update
        let idx = parseInt($('#simSlider').val(), 10) - 1;
        displayTeamsFlags(simData[idx]);
    }
});

}

// Helper to update the simulation modal content
function displaySimMatch(matchObj, allSimData) {
    if (!matchObj) return;
    $('#simMatchInfo').text('Match ' + matchObj.matchNumber);
    $('#simTeamsPicked').html(
  matchObj.teamsPicked.map(t => {
    const alliance = matchObj.teamsState[t]?.alliance || 'neutral';
    let badgeClass = (alliance === 'red') ? 'badge badge-danger' :
                     (alliance === 'blue') ? 'badge badge-primary' :
                     'badge badge-secondary';
    return `<span class="${badgeClass} mr-2">${t}</span>`;
  }).join('')
);


    // Show all matches so far if box checked
    let idx = allSimData.findIndex(m => m.matchNumber === matchObj.matchNumber);
displayAllMatchesSoFar(allSimData, idx);

    // Show team flags if box checked
    if ($('#showTeamFlagsCheckbox').is(':checked')) {
        displayTeamsFlags(matchObj);
    }
}
function displayAllMatchesSoFar(simData, currentIndex) {
    // Slice the data from match 1..(currentIndex+1)
    let partial = simData.slice(0, currentIndex + 1);
    // Build HTML
    let html = '<h5>Matches So Far</h5><ul>';
    partial.forEach(m => {
        html += `<li>Match ${m.matchNumber}: ${m.teamsPicked.join(', ')}</li>`;
    });
    html += '</ul>';

    $('#allMatchesList').html(html);
}
function displayTeamsFlags(matchObj) {
    // matchObj.teamsState is where we stored each team’s flagged/done
    const state = matchObj.teamsState || {};
    let teamNames = Object.keys(state).sort((a,b) => parseInt(a)-parseInt(b) || a.localeCompare(b));

    let html = '<h5>Team Flags</h5><ul style="list-style: none; padding-left: 0;">';
    teamNames.forEach(t => {
        let doneChecked = state[t].done ? 'checked' : '';
// For alliance-based color in the Flags panel
let alliance = state[t].alliance || 'neutral';
let colorStyle = '';
if (alliance === 'red') colorStyle = 'color: #dc3545';   // Red-ish
else if (alliance === 'blue') colorStyle = 'color: #007bff'; // Blue-ish

html += `
  <li style="${colorStyle}">
    <strong>Team ${t}</strong><br>
    <label>
      <input type="checkbox" disabled ${doneChecked}/> Can No Longer Be Picked
    </label>
  </li>
`;
    });
    html += '</ul>';

    $('#teamsFlagsContainer').html(html);
}

        </script>
<!-- Exclude Teams Modal -->
<!-- Exclude Teams Modal -->
<div class="modal fade" id="excludeTeamsModal" tabindex="-1" aria-labelledby="excludeTeamsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="excludeTeamsModalLabel">Exclude Teams</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="excludeTeamInput" style="color: #343a40">Exclude Teams:</label>
                    <input type="text" class="form-control" id="excludeTeamInput" placeholder="Enter team number">
                </div>
                <div class="form-group">
                    <label style="color: #343a40">Excluded Teams:</label>
                    <ul id="exclusionList" style="color: #343a40"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Simulation Modal -->
<div class="modal fade" id="simulationModal" tabindex="-1" aria-labelledby="simulationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 90%;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="simulationModalLabel">Scouting Simulation</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Controls (slider, play button) -->
          <div class="d-flex flex-wrap align-items-center mb-3">
            <input type="range" id="simSlider" min="1" max="1" value="1" class="custom-range" style="width: 80%;">
            <button id="playSimulation" class="btn btn-secondary ml-3">Play</button>
          </div>
          <!-- Display which match & which teams -->
           <!-- Additional Simulation Controls -->
<div class="form-check mb-2">
    <input class="form-check-input" type="checkbox" value="" id="showAllMatchesCheckbox">
    <label class="form-check-label" for="showAllMatchesCheckbox">
      Show All Matches So Far
    </label>
  </div>
  <div class="form-check mb-2">
    <input class="form-check-input" type="checkbox" value="" id="showTeamFlagsCheckbox">
    <label class="form-check-label" for="showTeamFlagsCheckbox">
      Show Team Flags
    </label>
  </div>
  
  <!-- Where we'll show the “All Matches So Far” list -->
  <div id="allMatchesList" style="display: none; margin-bottom: 15px;"></div>
  <!-- Where we show current team flags/done status -->
  <div id="teamsFlagsContainer" style="display: none;"></div>
  
          <div>
            <p id="simMatchInfo" style="font-weight: bold; margin-bottom: 10px;"></p>
            <div id="simTeamsPicked"></div>
          </div>
        </div>
      </div>
    </div>
  </div>  
</body>
<script>
    window.onload = function() {
        document.body.style.display = "block"; // Show body when everything is loaded
    };
</script>
</html>
