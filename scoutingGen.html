<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRC Scouting Page</title>
<style>
    .ui-autocomplete {
        z-index: 1051 !important; /* Bootstrap modals usually have a z-index of 1050 */
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .modal-body .form-group {
        margin-bottom: 10px; /* Adjust spacing between form groups in the modal */
    }
    #exclusionList li {
        margin-bottom: 5px; /* Spacing between list items */
    }
    .btn-spacing {
        margin-left: 10px;
    }
    .highlighted {
        background-color: #ffff99 !important;
    }
</style>
<!-- <link rel="stylesheet" href="jquery-ui.css">
<script src="jquery-3.5.1.min.js"></script>
<script src="jquery-ui.js"></script>
<script src="xlsx.full.min.js"></script>
<link href="bootstrap.min.css" rel="stylesheet">
<script src="bootstrap.min.js"></script> -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="./index.html">Robort</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./Team_List_element.html">Teams</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Scouting
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="./Strat_Board_w_tabs.html">Canvas</a>
                            <a class="dropdown-item" href="./scoutingGen.html">Scouting Generator</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./Checklist.html">Pre Match Checklist</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./2423_Features.html">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Config_tab.html">Configure</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
<div class="container">
    <h1>FRC Scouting List Generator</h1>
    <form id="scoutingForm">
        <div class="form-group">
            <label for="eventCode">Event Code:</label>
            <div class="input-group">
                <input type="text" class="form-control" id="eventCode" required>
                <div class="input-group-append">
                    <button class="btn btn-success" type="button" id="uploadButton">Upload</button>
                    <button class="btn btn-secondary" type="button" id="configButton">Config</button>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="teamsPerMatch">Teams per Match:</label>
            <input type="number" class="form-control" id="teamsPerMatch" min="1" max="6" required>
        </div>
        <div class="form-group">
            <label for="teamAppearances" title="Controls the maximum number of times a given team can appear for the entire competition.">Team Appearances: <span id="appearanceValue">1</span></label>
            <input type="range" class="custom-range" id="teamAppearances" min="1" max="12" value="1">
        </div>

        
        
        <button type="submit" class="btn btn-primary" id="fetchMatchesButton">Fetch Matches</button>
    <!-- Button to trigger modal -->
    <button type="button" class="btn btn-primary" id="excludeTeamsButton" data-toggle="modal" data-target="#excludeTeamsModal">
        Exclude Teams
    </button>
    <!-- Export to Excel button -->
<button type="button" id="exportExcel" class="btn btn-success" style="display:none;">Export to Excel</button>
<!-- Print button -->
<button type="button" id="printButton" class="btn btn-secondary" style="display:none;" onclick="printTable()">Print</button>
<div class="form-group">
    <div id="highlightGroup" style="display:none;">
    <label for="highlightTeamSelect"><br>Highlight Team:</label>
    <select class="form-control" id="highlightTeamSelect">
        <option value="">Select a team to highlight</option>
    </select>
</div>
</div>
    </form>
    <table class="table table-bordered mt-4 data-table">
        <thead style="display:none;">
            <tr>
                <th>Match</th>
                <th>Teams</th>
            </tr>
        </thead>
        <tbody id="matchData"></tbody>
    </table>
</div>
<div id="messageContainer" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <div class="alert alert-success" id="successMessage"></div>
</div>
 <!-- Alert Modal -->
 <div class="modal fade" id="customAlertModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">Alert</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="modalText">This is a modal replacing an alert.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<script>
    function collectTeams(matches) {
    var teams = [];
    matches.forEach(function(match) {
        match.alliances.red.team_keys.concat(match.alliances.blue.team_keys).forEach(function(team) {
            team = team.replace('frc', ''); // Normalize team number
            if (teams.indexOf(team) === -1) {
                teams.push(team);
            }
        });
    });
    updateHighlightTeamDropdown(teams.sort());
}

    function updateHighlightTeamDropdown(teams) {
    var select = $('#highlightTeamSelect');
    select.empty(); // Clear previous options
    select.append('<option value="">Select a team to highlight</option>');
    teams.forEach(function(team) {
        select.append($('<option></option>').val(team).text(team));
    });
}
$('#highlightTeamSelect').change(function() {
    var selectedTeam = $(this).val();
    $('.team-number').each(function() {
        $(this).css('background-color', ''); // Reset highlight for all team number spans
        if (selectedTeam && $(this).text() === selectedTeam) {
            $(this).css('background-color', '#ffff99'); // Apply highlight color
        }
    });
});

        document.addEventListener('DOMContentLoaded', function() {
  const originalAlert = window.alert;
  
  window.alert = function(message) {
    $('#modalText').text(message); // Set the text of the modal to the alert message
    $('#customAlertModal').modal('show'); // Show the Bootstrap modal
  };
});

    function displaySuccessMessage(message) {
    var messageBox = $('#successMessage');
    messageBox.text(message);
    $('#messageContainer').fadeIn();

    setTimeout(function() {
        $('#messageContainer').fadeOut();
    }, 4000); // Message will fade out after 4 seconds
}

    $(document).ready(function() {
        $('#excludeTeamsButton').hide(); 
        // Handling the form submission
        $('#scoutingForm').on('submit', function(e) {
            e.preventDefault();
            fetchMatches($('#eventCode').val(), parseInt($('#teamsPerMatch').val(), 10));
        });
    
        // Configuration button navigation
        $('#configButton').click(function() {
            window.location.href = 'Config_tab.html';
        });
    
        // Slider adjustment and display update
        $('#teamAppearances').on('input', function() {
            $('#appearanceValue').text($(this).val());
        });
    
        // Disable the event code input if a code is stored
        var storedEventCode = localStorage.getItem('eventCode');
        if (storedEventCode) {
            $('#eventCode').val(storedEventCode);
            $('#eventCode').prop('disabled', true);
        }
    });
    
    // Fetch matches from The Blue Alliance API
    function fetchMatches(eventCode, teamsPerMatch) {
        if ($('#fetchMatchesButton').text() === 'Fetch Matches from Upload') {
        var matches = JSON.parse(localStorage.getItem('uploadedMatches'));
        displayMatches(matches, teamsPerMatch);
        originalMatches = matches;
        $('#excludeTeamsButton').show();
    } else {
        var url = `https://www.thebluealliance.com/api/v3/event/${eventCode}/matches/simple`;
        $.ajax({
            url: url,
            headers: {
                'X-TBA-Auth-Key': 'J43Af3iggAp3XBvsVaGm5Hbc7IlK6XR8W8WxQhLDlPiQbv6BbW8LWDvVg8Zj9fCV' // Replace with your actual API Key
            },
            success: function(data) {
                data = data.filter(match => match.comp_level === 'qm');
                data.sort((a, b) => a.match_number - b.match_number);
                originalMatches = data;
                displayMatches(data, teamsPerMatch);
                $('#excludeTeamsButton').show(); 
            },
            error: function() {
                alert('Failed to retrieve data. Check the event code and your internet connection.');
            }
        });
    }
    }
    
    // Display the matches in the table with filtering based on team appearances
    function displayMatches(matches, teamsPerMatch) {
    $('#matchData').parents('table').find('thead').show();
    $('#exportExcel').show();
    $('#printButton').show();
    $('#excludeTeamButton').show();
    $('#highlightGroup').show();
    var matchData = '';
    let appearanceCount = {};

    matches.forEach(function(match, index) {
        var teams = match.alliances.red.team_keys.concat(match.alliances.blue.team_keys);
        teams = teams.map(team => team.replace('frc', '')); // Normalize team numbers

        // Initially filter teams based on the current appearances not exceeding the max allowed
        let potentialTeams = teams.filter(team => (appearanceCount[team] || 0) < $('#teamAppearances').val());

        // Now limit the teams based on the 'Teams per Match' setting
        let displayedTeams = [];
        for (let i = 0; i < potentialTeams.length && displayedTeams.length < teamsPerMatch; i++) {
            let team = potentialTeams[i];
            // Check if adding this team would exceed their appearance limit
            if ((appearanceCount[team] || 0) + 1 <= $('#teamAppearances').val()) {
                appearanceCount[team] = (appearanceCount[team] || 0) + 1;
                displayedTeams.push(team);
            }
        }

        // Add the match row only if there are displayed teams
        if (displayedTeams.length > 0) {
            matchData += `<tr><td>Match ${match.match_number}</td><td>${displayedTeams.map(team => `<span class='team-number'>${team}</span>`).join(', ')}</td></tr>`;
        }
    });

    $('#matchData').html(matchData);
    setupTeamAutocomplete(); 
    collectTeams(matches); 
}

let exclusionList = [];

$(document).ready(function() {
    var availableTeams = [];  // This will store the teams loaded for Autocomplete

    function setupTeamAutocomplete() {
        $("#matchData tr td:nth-child(2)").each(function() {
            var teams = $(this).text().split(', ');
            teams.forEach(function(team) {
                if (availableTeams.indexOf(team) === -1) {
                    availableTeams.push(team);
                }
            });
        });

        $('#excludeTeamInput').autocomplete({
            source: availableTeams,
            select: function(event, ui) {
                $(this).data('autocomplete-selected', true);  // Flag that a valid selection was made
            }
        });
    }

    $('#addExclusion').click(function() {
        var teamNum = $('#excludeTeamInput').val().trim();
        var isSelectedFromDropdown = $('#excludeTeamInput').data('autocomplete-selected');  // Check the flag

        // Only add the team if it was selected from the dropdown
        if (teamNum && isSelectedFromDropdown) {
            if (!exclusionList.includes(teamNum)) {
                exclusionList.push(teamNum);
                updateExclusionListDisplay();
                filterMatches();
            }
            $('#excludeTeamInput').val('');  // Clear input
            $('#excludeTeamInput').removeData('autocomplete-selected');  // Reset the flag
        } else {
            alert('Please select a team from the dropdown list.');
            $('#excludeTeamInput').focus();
        }
    });
});

function updateExclusionListDisplay() {
    var listHtml = '';
    exclusionList.forEach(function(team) {
        listHtml += `<li>${team} <button onclick="removeFromExclusion('${team}')" class="btn btn-sm btn-danger">Remove</button></li>`;
    });
    $('#exclusionList').html(listHtml);
}

function removeFromExclusion(team) {
    var index = exclusionList.indexOf(team);
    if (index > -1) {
        exclusionList.splice(index, 1);
        updateExclusionListDisplay();
        filterMatches(); // Refilter matches whenever the list changes
    }
}

function filterMatches() {
    // Filter the original matches based on the exclusion list
    var filteredMatches = originalMatches.filter(match => {
        var teams = match.alliances.red.team_keys.concat(match.alliances.blue.team_keys);
        teams = teams.map(team => team.replace('frc', ''));
        return !teams.some(team => exclusionList.includes(team));
    });
    
    // Display the matches after filtering
    displayMatches(filteredMatches, parseInt($('#teamsPerMatch').val(), 10));
}

function setupTeamAutocomplete() {
    var availableTeams = [];
    $("#matchData tr td:nth-child(2)").each(function() {
        var teams = $(this).text().split(', ');
        teams.forEach(function(team) {
            if (availableTeams.indexOf(team) === -1) {
                availableTeams.push(team);
            }
        });
    });

    $('#excludeTeamInput').autocomplete({
        source: availableTeams,
        select: function(event, ui) {
            if (!exclusionList.includes(ui.item.value)) {
                exclusionList.push(ui.item.value);
                updateExclusionListDisplay();
                filterMatches();
            }
            $(this).val(''); // Clear input after selection
            return false; // Prevent the widget from inserting the value.
        }
    });
}

function exportTableToExcel(tableID){
    var eventCode = $('#eventCode').val(); // Get the event code from the input
    var filename = `ScoutingList_${eventCode}`; // Create filename with event code
    let table = document.getElementById(tableID);
    let workbook = XLSX.utils.table_to_book(table);
    XLSX.writeFile(workbook, `${filename}.xlsx`);
}

$('#exportExcel').click(function(){
    exportTableToExcel('matchData');
});

function printTable() {
    var table = document.querySelector('.data-table').outerHTML;
    var printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Print Table</title>');
    printWindow.document.write('<link rel="stylesheet" href="bootstrap.min.css" />');
    printWindow.document.write('<style>');
    printWindow.document.write('@media print { body { width: 100%; margin: 0; font-size: 4pt; } .data-table { width: 100%; font-size: 6pt; } .data-table th, .data-table td { padding: 2px; } .navbar, #buttonContainer { display: none; } }');
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(table);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}
$('#uploadButton').click(function() {
    $('<input type="file" accept=".json">').on('change', function(event) {
        var fileReader = new FileReader();
        fileReader.onload = function(e) {
            try {
                var jsonData = JSON.parse(e.target.result);
                if (Array.isArray(jsonData) && jsonData.every(match => match.hasOwnProperty('event_key'))) {
                    localStorage.setItem('uploadedMatches', JSON.stringify(jsonData));
                    $('#eventCode').val(jsonData[0].event_key);
                    $('#fetchMatchesButton').text('Fetch Matches from Upload');
                    $('<button class="btn btn-danger btn-spacing" type="button" id="cancelUploadButton">Cancel</button>')
                        .insertAfter('#fetchMatchesButton')
                        .click(function() {
                            $(this).remove();
                            $('#fetchMatchesButton').text('Fetch Matches');
                            $('#uploadButton').prop('disabled', false);
                            localStorage.removeItem('uploadedMatches'); // Ensures clean state
                        });
                    $('#uploadButton').prop('disabled', true);
                    $('#eventCode').prop('disabled', true);
                    displaySuccessMessage('File loaded successfully.');
                } else {
                    alert('Invalid JSON format');
                }
            } catch (error) {
                alert('Error reading JSON file');
            }
        };
        fileReader.readAsText(event.target.files[0]);
    }).click();
});


    </script>
<!-- Exclude Teams Modal -->
<!-- Exclude Teams Modal -->
<div class="modal fade" id="excludeTeamsModal" tabindex="-1" aria-labelledby="excludeTeamsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="excludeTeamsModalLabel">Exclude Teams</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="excludeTeamInput">Exclude Teams:</label>
                    <input type="text" class="form-control" id="excludeTeamInput" placeholder="Enter team number">
                </div>
                <div class="form-group">
                    <label>Excluded Teams:</label>
                    <ul id="exclusionList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
